# ===========================================
# Al-Haramain Store Frontend - Deploy to Railway
# ===========================================
# Deploys to Railway on push to main
# ===========================================

name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

env:
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  # ===========================================
  # Deploy to Railway
  # ===========================================
  deploy:
    name: üöÄ Deploy to Railway
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: üìö Install dependencies
        run: npm ci --legacy-peer-deps

      - name: üß™ Run tests
        run: npm run test -- --passWithNoTests

      - name: üèóÔ∏è Build application
        run: npm run build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_SESSION_DOMAIN: ${{ secrets.VITE_SESSION_DOMAIN }}
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}

      - name: üöÄ Install Railway CLI
        run: npm install -g @railway/cli

      - name: üöÄ Deploy to Railway
        id: deploy
        run: |
          railway link --environment production
          railway up --detach
          echo "url=$(railway status --json | jq -r '.deploymentUrl')" >> $GITHUB_OUTPUT
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

      - name: üì¢ Deployment notification
        run: |
          echo "‚úÖ Deployment successful!"
          echo "üåê URL: ${{ steps.deploy.outputs.url }}"

  # ===========================================
  # Post-Deployment Health Check
  # ===========================================
  health-check:
    name: üè• Health Check
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: üè• Check deployment health
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30

          # Health check (adjust URL as needed)
          HEALTH_URL="${{ needs.deploy.outputs.url }}/health"

          for i in {1..5}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi
            
            echo "Attempt $i: HTTP $HTTP_STATUS - Retrying in 10s..."
            sleep 10
          done

          echo "‚ö†Ô∏è Health check did not return 200, but deployment may still be successful"
        continue-on-error: true
