# ===========================================
# Al-Haramain Store Frontend - PR Checks
# ===========================================
# Runs additional checks on Pull Requests
# ===========================================

name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  # ===========================================
  # PR Size Check
  # ===========================================
  pr-size:
    name: üìè PR Size
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìè Check PR size
        run: |
          ADDITIONS=$(gh pr view ${{ github.event.pull_request.number }} --json additions -q '.additions')
          DELETIONS=$(gh pr view ${{ github.event.pull_request.number }} --json deletions -q '.deletions')
          TOTAL=$((ADDITIONS + DELETIONS))

          echo "üìä PR Stats:"
          echo "  Additions: +$ADDITIONS"
          echo "  Deletions: -$DELETIONS"
          echo "  Total changes: $TOTAL"

          if [ $TOTAL -gt 1000 ]; then
            echo "‚ö†Ô∏è Large PR detected ($TOTAL lines). Consider breaking it into smaller PRs."
          elif [ $TOTAL -gt 500 ]; then
            echo "üìù Medium PR ($TOTAL lines)"
          else
            echo "‚úÖ Small PR ($TOTAL lines)"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  # ===========================================
  # Commit Message Check
  # ===========================================
  commit-lint:
    name: üìù Commit Messages
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìù Check commit message format
        run: |
          echo "Checking commit messages follow conventional format..."
          COMMITS=$(git log origin/${{ github.base_ref }}..HEAD --pretty=format:"%s")

          echo "Commits in this PR:"
          echo "$COMMITS"

          # Check for conventional commit prefixes
          VALID_PREFIXES="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"

          while IFS= read -r commit; do
            if [[ ! "$commit" =~ ^($VALID_PREFIXES)(\(.+\))?: ]]; then
              echo "‚ö†Ô∏è Commit doesn't follow conventional format: $commit"
              echo "Expected format: type(scope): description"
              echo "Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
            fi
          done <<< "$COMMITS"

          echo "‚úÖ Commit message check complete"

  # ===========================================
  # Security Audit
  # ===========================================
  security:
    name: üîí Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: üîí Run npm audit
        run: npm audit --audit-level=high || true
        continue-on-error: true

      - name: üîç Check for secrets
        run: |
          echo "Scanning for potential secrets..."

          # Check for common secret patterns
          if grep -rE "(api[_-]?key|secret|password|token)\s*[:=]\s*['\"][^'\"]+['\"]" --include="*.ts" --include="*.tsx" --include="*.js" src/ 2>/dev/null; then
            echo "‚ö†Ô∏è Potential hardcoded secrets found. Please review."
          else
            echo "‚úÖ No obvious hardcoded secrets detected"
          fi
